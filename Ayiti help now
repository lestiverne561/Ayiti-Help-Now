import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { PDFDocument } from "https://esm.sh/pdf-lib";

serve(async (req) => {
  const data = await req.json();

  const formUrl = "https://your-supabase-url.storage/v1/object/public/forms/I-589_Fillable_Template_for_PDFLib.pdf";
  const existingPdfBytes = await fetch(formUrl).then((res) => res.arrayBuffer());

  const pdfDoc = await PDFDocument.load(existingPdfBytes);
  const form = pdfDoc.getForm();

  // Example field population (you can change field names based on your form)
  form.getTextField("FullName").setText(data.fullName || "John Doe");
  form.getTextField("DOB").setText(data.dob || "01/01/1990");
  form.getTextField("Country").setText(data.country || "Haiti");

  form.flatten();

  const pdfBytes = await pdfDoc.save();

  const generatedResponse = {
    message: "Nou ranpli fòm I-589 ou avèk siksè ✅. Telechaje PDF la.",
    pdfBase64: btoa(String.fromCharCode(...new Uint8Array(pdfBytes))),
  };

  return new Response(
    JSON.stringify(generatedResponse),
    {
      headers: { "Content-Type": "application/json" },
      status: 200,
    }
  );
});
